<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POSP Payout Checker - Srinithi Insurance Corporation</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Work+Sans:wght@300;400;500;600&display=swap');

        :root {
            color-scheme: light;
            --bg: #f1f4fb;
            --bg-accent: #e4ebf9;
            --card: #ffffff;
            --ink: #1b1b1f;
            --muted: #5b6173;
            --primary: #2a59c6;
            --primary-strong: #1c3f9e;
            --primary-soft: #e8f0ff;
            --accent: #f3d8ae;
            --border: rgba(42, 89, 198, 0.14);
            --shadow: 0 26px 56px rgba(33, 64, 150, 0.14);
            --radius-lg: 28px;
            --radius-md: 20px;
            --radius-sm: 14px;
            --field-bg: #f7f9ff;
            --field-border: rgba(42, 89, 198, 0.18);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            min-height: 100vh;
            font-family: "Work Sans", "Helvetica Neue", sans-serif;
            color: var(--ink);
            background:
                radial-gradient(circle at top, #ffffff 0%, var(--bg) 55%, var(--bg-accent) 100%);
            text-rendering: optimizeLegibility;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body::before {
            content: "";
            position: fixed;
            inset: 0;
            background:
                linear-gradient(120deg, rgba(219, 227, 255, 0.65), rgba(255, 255, 255, 0) 45%),
                linear-gradient(320deg, rgba(33, 63, 153, 0.12), rgba(255, 255, 255, 0) 40%);
            pointer-events: none;
            z-index: -1;
        }

        .page {
            padding: 56px 24px 90px;
        }

        .container {
            max-width: 1140px;
            margin: 0 auto;
            background: var(--card);
            padding: 34px 36px 44px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            border: 1px solid rgba(27, 62, 166, 0.12);
            transition: box-shadow 0.25s ease, transform 0.25s ease;
            background: linear-gradient(180deg, #ffffff 0%, #f9fbff 100%);
        }

        .header {
            display: grid;
            grid-template-columns: auto 1fr;
            align-items: center;
            gap: 24px;
            padding-bottom: 24px;
            border-bottom: 1px solid rgba(42, 89, 198, 0.12);
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 18px;
        }

        .brand img {
            max-width: 150px;
            height: auto;
            display: block;
        }

        .title-block {
            text-align: left;
        }

        .title-block h1 {
            font-family: "Space Grotesk", "Helvetica Neue", sans-serif;
            font-size: 30px;
            margin: 0 0 6px;
            color: #2a59c6;
            letter-spacing: -0.02em;
        }

        .title-block p {
            margin: 0;
            color: var(--muted);
            font-size: 15px;
        }

        .hero-chip {
            background: var(--primary-soft);
            color: var(--primary-strong);
            padding: 10px 16px;
            border-radius: 999px;
            font-weight: 600;
            font-size: 13px;
            letter-spacing: 0.04em;
            text-transform: uppercase;
        }

        form {
            margin-top: 32px;
            display: grid;
            gap: 24px;
        }

        .section {
            padding: 22px 22px 26px;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            background: linear-gradient(180deg, #ffffff 0%, #f8faff 100%);
            box-shadow: 0 14px 26px rgba(42, 89, 198, 0.08);
            transition: box-shadow 0.2s ease, transform 0.2s ease, border-color 0.2s ease;
        }

        @keyframes fade-up {
            from {
                opacity: 0;
                transform: translateY(12px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .container {
            animation: fade-up 0.6s ease both;
        }

        form .section {
            animation: fade-up 0.5s ease both;
        }

        form .section:nth-of-type(1) { animation-delay: 0.04s; }
        form .section:nth-of-type(2) { animation-delay: 0.08s; }
        form .section:nth-of-type(3) { animation-delay: 0.12s; }
        form .section:nth-of-type(4) { animation-delay: 0.16s; }
        form .section:nth-of-type(5) { animation-delay: 0.2s; }
        form .section:nth-of-type(6) { animation-delay: 0.24s; }

        .section-title {
            font-family: "Space Grotesk", "Helvetica Neue", sans-serif;
            color: #2a59c6;
            margin-bottom: 16px;
            font-size: 17px;
            font-weight: 700;
            letter-spacing: -0.01em;
        }

        .section-body {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 16px 18px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        label {
            font-weight: 600;
            color: var(--ink);
            font-size: 14px;
        }

        select,
        input[type="number"] {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid var(--field-border);
            border-radius: var(--radius-sm);
            font-size: 14px;
            background: linear-gradient(180deg, #ffffff 0%, #f7f9ff 100%);
            color: var(--ink);
            transition: border-color 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease;
        }

        select:focus,
        input[type="number"]:focus {
            outline: none;
            border-color: #2a59c6;
            box-shadow: 0 0 0 3px rgba(42, 89, 198, 0.16);
            transform: translateY(-1px);
        }

        .rto-code {
            display: grid;
            grid-template-columns: 72px 1fr;
            align-items: center;
            gap: 0;
        }

        .rto-prefix {
            padding: 12px 10px;
            border: 1px solid var(--field-border);
            border-radius: var(--radius-sm) 0 0 var(--radius-sm);
            background: linear-gradient(180deg, #eef3ff 0%, #e3ecff 100%);
            text-align: center;
            font-weight: 700;
            color: #2a59c6;
            letter-spacing: 0.05em;
        }

        .rto-number {
            border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
            border-left: none;
        }

        .section-actions {
            display: grid;
            grid-template-columns: 1fr;
        }

        button {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            padding: 14px 18px;
            background: linear-gradient(140deg, #2a59c6, #21479e);
            color: #fff;
            border: none;
            border-radius: 999px;
            font-size: 15px;
            font-weight: 600;
            letter-spacing: 0.02em;
            cursor: pointer;
            box-shadow: 0 18px 34px rgba(42, 89, 198, 0.22);
            transition: transform 0.2s ease, box-shadow 0.2s ease, filter 0.2s ease;
        }

        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 24px 45px rgba(33, 63, 153, 0.28);
        }

        button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        #results-section {
            margin-top: 36px;
        }

        .results-card {
            padding: 26px 28px;
            border-radius: 20px;
            border: 1px solid rgba(42, 89, 198, 0.14);
            background: linear-gradient(180deg, #ffffff 0%, #f7f9ff 100%);
            box-shadow: 0 18px 36px rgba(42, 89, 198, 0.1);
            margin-bottom: 20px;
            transition: transform 0.25s ease, box-shadow 0.25s ease;
        }

        .results-card h3 {
            margin: 0 0 18px;
            font-family: "Space Grotesk", "Helvetica Neue", sans-serif;
            color: #2a59c6;
            font-size: 19px;
            letter-spacing: -0.01em;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(42, 89, 198, 0.12);
        }

        #criteria-summary {
            padding: 16px 18px 18px;
            background: linear-gradient(180deg, #f6f8ff 0%, #eef3ff 100%);
            border: 1px solid rgba(42, 89, 198, 0.12);
            border-radius: 16px;
            font-size: 14px;
            color: var(--ink);
        }

        #results-message {
            padding: 12px 16px;
            border: 1px solid rgba(42, 89, 198, 0.18);
            border-radius: 14px;
            background: linear-gradient(180deg, #eef3ff 0%, #e6edff 100%);
            color: #1b2f75;
            font-weight: 600;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
            overflow: hidden;
            border-radius: 14px;
            background: #fff;
            box-shadow: 0 14px 26px rgba(42, 89, 198, 0.08);
        }

        .results-table thead tr {
            background: linear-gradient(135deg, #2a59c6, #1b3f92);
            color: #fff;
            text-align: left;
        }

        .results-table th,
        .results-table td {
            padding: 14px 14px;
            border: 1px solid rgba(42, 89, 198, 0.1);
        }

        .text-right {
            text-align: right;
        }

        .results-table tbody tr:nth-child(even) {
            background: #f5f7ff;
        }

        .results-table tbody tr:hover {
            background: rgba(33, 63, 153, 0.08);
        }

        .table-rank {
            text-align: center;
            font-weight: 700;
            color: var(--primary-strong);
        }

        .table-payout {
            text-align: right;
            font-weight: 700;
            color: #213f99;
        }

        .table-company strong {
            color: var(--ink);
        }

        .company-note {
            display: inline-block;
            margin-top: 4px;
            font-size: 0.9em;
            color: var(--muted);
        }

        .payout-unit {
            margin-left: 2px;
            font-size: 0.95em;
            color: #8f1f2a;
            font-weight: 600;
        }

        .criteria-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 12px 14px;
            margin-top: 14px;
        }

        .criteria-item {
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding: 12px 14px;
            border-radius: 14px;
            background: linear-gradient(180deg, #ffffff 0%, #f5f7ff 100%);
            border: 1px solid rgba(42, 89, 198, 0.12);
            box-shadow: 0 10px 20px rgba(42, 89, 198, 0.06);
            min-height: 64px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .criteria-key {
            font-weight: 700;
            color: #2a59c6;
            font-size: 11px;
            letter-spacing: 0.08em;
            text-transform: uppercase;
        }

        .criteria-value {
            color: var(--ink);
            font-weight: 600;
            font-size: 14px;
        }

        .results-card h3 {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .results-subtitle {
            font-size: 12px;
            color: #5b647a;
            font-weight: 600;
            letter-spacing: 0.02em;
        }

        .payout-unit {
            margin-left: 2px;
            font-size: 0.95em;
            color: #8f1f2a;
            font-weight: 600;
        }

        .criteria-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 14px 28px rgba(42, 89, 198, 0.12);
        }

        .results-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 22px 42px rgba(42, 89, 198, 0.14);
        }

        .section:hover {
            border-color: rgba(42, 89, 198, 0.22);
            box-shadow: 0 18px 32px rgba(42, 89, 198, 0.12);
        }

        @media (prefers-reduced-motion: reduce) {
            * {
                animation: none !important;
                transition: none !important;
            }
        }

        @media (max-width: 900px) {
            .header {
                grid-template-columns: 1fr;
            }

            .section-body {
                grid-template-columns: 1fr;
            }

            .container {
                padding: 26px 20px 30px;
            }
        }

        @media (max-width: 600px) {
            .page {
                padding: 32px 16px 60px;
            }

            .title-block h1 {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="page">
        <div class="container">
            <div class="header">
                <div class="brand">
                    <img src="/static/logo/dark-logo-min.png" alt="Srinithi Insurance Corporation Logo">
                </div>
                <div class="title-block">
                    <h1>POSP Payout Checker</h1>
                </div>
                <div aria-hidden="true"></div>
            </div>
            
            <form action="/check-payout" method="post">
            <div class="section">
                <div class="section-title">Location</div>
                <div class="section-body">
                    <div class="form-group">
                        <label for="state">State</label>
                        <select id="state" name="state">
                            <option value="" selected>-- Choose State --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>RTO Code</label>
                        <div class="rto-code">
                            <span id="rto-prefix" class="rto-prefix">XX</span>
                            <select id="rto-number" name="rto_number" class="rto-number">
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        
        <div class="section">
            <div class="section-title">Vehicle Classification</div>
            <div class="section-body">
                <div class="form-group">
                    <label for="vehicle-category">Vehicle Category</label>
                    <select id="vehicle-category" name="vehicle_category">
                        <option value="" selected>-- Choose Vehicle Category --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="vehicle-type">Vehicle Sub-Category</label>
                    <select id="vehicle-type" name="vehicle_type">
                    </select>
                </div>
                <div class="form-group" id="make-group" style="display: none;">
                    <label for="make">Make</label>
                    <select id="make" name="make">
                    </select>
                </div>
                <div class="form-group" id="model-group" style="display: none;">
                    <label for="model">Model</label>
                    <select id="model" name="model">
                    </select>
                </div>
                <div class="form-group" id="seating-group" style="display: none;">
                    <label for="seating-capacity">Seating Capacity</label>
                    <select id="seating-capacity" name="seating_capacity">
                        <option value="" selected>-- Choose Seating Capacity --</option>
                    </select>
                </div>
                <div class="form-group" id="fuel-group">
                    <label for="fuel-type">Fuel Type</label>
                    <select id="fuel-type" name="fuel_type">
                        <option value="" selected>-- Choose Fuel Type --</option>
                    </select>
                </div>
                <div class="form-group" id="cc-group" style="display: none;">
                    <label for="cc-slab">CC Slab</label>
                    <select id="cc-slab" name="cc_slab">
                        <option value="" selected>-- Choose CC Slab --</option>
                    </select>
                </div>
                <div class="form-group" id="gvw-group" style="display: none;">
                    <label for="gvw-value">GVW (kg)</label>
                    <input type="number" id="gvw-value" name="gvw_value" min="0" step="any" placeholder="e.g. 2350" />
                </div>
                <div class="form-group" id="watt-group" style="display: none;">
                    <label for="watt-slab">Watt Slab</label>
                    <select id="watt-slab" name="watt_slab">
                        <option value="" selected>-- Choose Watt Slab --</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="section">
            <div class="section-title">Vehicle Age</div>
            <div class="section-body">
                <div class="form-group">
                    <label for="vehicle-age">Age</label>
                    <select id="vehicle-age" name="vehicle_age">
                        <option value="">-- Choose Vehicle Age --</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="section">
            <div class="section-title">Policy Details</div>
            <div class="section-body">
                <div class="form-group">
                    <label for="policy-type">Policy Type</label>
                    <select id="policy-type" name="policy_type">
                        <option value="">-- Choose Policy Type --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="business-type">Business Type</label>
                    <select id="business-type" name="business_type">
                        <option value="">-- Choose Business Type --</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="section">
            <div class="section-title">NCB (No Claim Bonus)</div>
            <div class="section-body">
                <div class="form-group">
                    <label for="ncb-slab">NCB Applicable</label>
                    <select id="ncb-slab" name="ncb_slab">
                        <option value="">-- Choose --</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="section">
            <div class="section-title">Covers and Flags</div>
            <div class="section-body">
                <div class="form-group">
                    <label for="cpa-cover">CPA Cover</label>
                    <select id="cpa-cover" name="cpa_cover">
                        <option value="">-- Choose --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="zero-dep">Zero Depreciation</label>
                    <select id="zero-dep" name="zero_dep">
                        <option value="">-- Choose --</option>
                    </select>
                </div>
                <div class="form-group" id="trailer-group" style="display: none;">
                    <label for="trailer">Trailer Attached</label>
                    <select id="trailer" name="trailer">
                        <option value="">-- Choose --</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="section-actions">
            <button type="submit">Calculate Payout</button>
        </div>
        </form>

        <!-- Results Section -->
        <div id="results-section" style="display: none;">
            <div class="results-card">
                <h3>Query Criteria</h3>
                <div id="criteria-summary"></div>
            </div>
            <div class="results-card">
                <h3>Top Insurers with Payout</h3>
                <div id="results-message"></div>
                <table id="results-table" class="results-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Insurance Company and Conditions</th>
                            <th class="text-right">Payout (rp)</th>
                        </tr>
                    </thead>
                    <tbody id="results-body">
                    </tbody>
                </table>
            </div>
        </div>

    <script>
        // ==================== RTO MASTER DATA ====================
        const rtoMasterData = {
            'TN': { '01': 'CHENNAI CENTRAL RTO', '02': 'CHENNAI (NORTH WEST) RTO', '03': 'CHENNAI (NORTH EAST) RTO', '04': 'CHENNAI (EAST) RTO', '05': 'CHENNAI (NORTH) RTO', '06': 'CHENNAI (SOUTH-EAST) RTO', '07': 'CHENNAI (SOUTH) RTO', '09': 'CHENNAI WEST RTO', '10': 'CHENNAI (SOUTH-WEST) RTO', '11': 'TAMBARAM RTO', '12': 'PARUTHIPATTU RTO', '13': 'AMBATTUR RTO', '14': 'SHOLINGANALLUR RTO', '15': 'ULUNDURPET RTO', '15M': 'KALAKURICHI RTO', '16': 'TINDIVANAM RTO', '18': 'REDHILLS RTO', '19': 'CHENGALPATTU RTO', '20': 'THIRUVALLUR RTO', '21': 'KANCHIPURAM RTO', '22': 'MEENAMBAKKAM RTO', '23': 'VELLORE RTO', '24': 'KRISHNAGIRI RTO', '25': 'TIRUVANNAMALAI RTO', '28': 'NAMAKKAL (NORTH) RTO', '29': 'DHARMAPURI RTO', '30': 'SALEM (WEST) RTO', '31': 'CUDDALORE RTO', '32': 'VILUPPURAM RTO', '33': 'ERODE EAST RTO', '34': 'TIRUCHENGODE RTO', '36': 'GOBI RTO', '37': 'COIMBATORE (SOUTH) RTO', '38': 'COIMBATORE NORTH RTO', '39': 'TIRUPUR NORTH RTO', '40': 'METTUPALAYAM RTO', '41': 'POLLACHI RTO', '42': 'TIRUPUR SOUTH RTO', '43': 'OOTY RTO', '45': 'TRICHY WEST RTO', '46': 'PERAMBALUR RTO', '47': 'KARUR RTO', '48': 'SRIRANGAM RTO', '49': 'THANJAVUR RTO', '50': 'TIRUVARUR RTO', '51': 'NAGAPATTINAM RTO', '52': 'SANKAGIRI RTO', '54': 'SALEM (EAST) RTO', '55': 'PUDUKKOTTAI RTO', '56': 'PERUNDURAI RTO', '57': 'DINDIGUL RTO', '58': 'MADURAI (SOUTH) RTO', '59': 'MADURAI (NORTH) RTO', '60': 'THENI RTO', '61': 'ARIYALUR RTO', '63': 'SIVAGANGAI RTO', '64': 'MADURAI (CENTRAL) RTO', '65': 'RAMANATHAPURAM RTO', '66': 'COIMBATORE (CENTRAL) RTO', '67': 'VIRUDHUNAGAR RTO', '68': 'KUMBAKONAM RTO', '69': 'TUTICORIN RTO', '70': 'HOSUR RTO', '72': 'TIRUNELVELI RTO', '73': 'RANIPET RTO', '74': 'NAGERCOIL RTO', '75': 'MARTHANDAM RTO', '76': 'TENKASI RTO', '77': 'ATTUR RTO', '78': 'DHARAPURAM RTO', '79': 'SANKARANKOVIL RTO', '81': 'TRICHY (EAST) RTO', '82': 'MAYILADUTHURAI RTO', '83': 'VANIYAMBADI RTO', '83M': 'TIRUPATTUR RTO', '84': 'SRIVILLIPUTTUR RTO', '85': 'KUNDRATHUR RTO', '86': 'ERODE WEST RTO', '87': 'SRIPERUMBUDUR RTO', '88': 'NAMAKKAL SOUTH RTO', '90': 'SALEM (SOUTH) RTO', '91': 'CHIDHAMBARAM RTO', '92': 'THIRUCHENDUR RTO', '93': 'METTUR RTO', '94': 'PALANI RTO', '95': 'SIVAKASI RTO', '96': 'KOVILPATTI RTO', '97': 'ARANI RTO', '99': 'COIMBATORE (WEST) RTO' },
            'KA': { '01': 'Koramangala', '02': 'Rajajinagar', '03': 'Indiranagar', '04': 'Yeshwanthpur', '05': 'Jayanagar', '06': 'Tumkur', '07': 'Kolar', '08': 'Kolar Gold Fields', '09': 'Mysuru', '10': 'Chamarajanagar', '11': 'Mandya', '12': 'Madikeri', '13': 'Hassan', '14': 'Shivamogga', '15': 'Sagara', '16': 'Chitradurga', '17': 'Davanagere', '18': 'Chikkamagaluru', '19': 'Mangaluru', '20': 'Udupi', '21': 'Puttur', '22': 'Belagavi', '23': 'Chikkodi', '24': 'Bailhongal', '25': 'Dharwad', '26': 'Gadag', '27': 'Haveri', '28': 'Vijayapura', '29': 'Bagalkote', '30': 'Karwar', '31': 'Sirsi', '32': 'Kalaburagi', '33': 'Yadgir', '34': 'Ballari', '35': 'Hosapete', '36': 'Raichur', '37': 'Koppal', '38': 'Bidar', '39': 'Bhalki', '40': 'Chikkaballapura', '41': 'Jnana Bharathi', '42': 'Ramanagara', '43': 'Devanahalli', '44': 'Tiptur', '45': 'Hunsur', '46': 'Sakleshpura', '47': 'Honnavar', '48': 'Jamkhandi', '49': 'Gokak', '50': 'Yelahanka', '51': 'Electronic City', '52': 'Nelamangala', '53': 'KR Puram', '57': 'Shantinagar', '58': 'Chamrajpet', '59': 'Chandapura', '60': 'RT Nagar', '61': 'Marathahalli', '63': 'Dharwad East', '64': 'Madhugiri', '65': 'Dandeli', '66': 'Tarikere', '67': 'Chintamani', '68': 'Ranebennur', '69': 'Ramdurg', '70': 'Bantwal', '71': 'Athani' },
            'KL': { '01': 'Thiruvananthapuram', '02': 'Kollam', '03': 'Pathanamthitta', '04': 'Alappuzha', '05': 'Kottayam', '06': 'Idukki', '07': 'Ernakulam', '08': 'Thrissur', '09': 'Palakkad', '10': 'Malappuram', '11': 'Kozhikode', '12': 'Wayanad', '13': 'Kannur', '14': 'Kasargode', '15': 'Kerala', '16': 'Attingal', '17': 'Muvattupuzha', '18': 'Vadakara', '19': 'Parassala', '20': 'Neyyattinkara', '21': 'Nedumangad', '22': 'Kazhakkoottam', '23': 'Karunagapally', '24': 'Kottarakara', '25': 'Punalur', '26': 'Adoor', '28': 'Mallappally', '29': 'Kayamkulam', '30': 'Chengannur', '31': 'Mavelikara', '32': 'Cherthala', '33': 'Changanassery', '34': 'Kanjirappally', '35': 'Pala', '36': 'Vaikom', '37': 'Vandiperiyar', '38': 'Thodupuzha', '39': 'Thripunithura', '40': 'Perumbavoor', '41': 'Aluva', '42': 'North Paravur', '43': 'Mattancherry', '44': 'Kothamangalam', '45': 'Irinjalakuda', '46': 'Guruvayur', '47': 'Kodungallur', '48': 'Wadakkancherry', '49': 'Alathur', '50': 'Mannarghat', '51': 'Ottappalam', '52': 'Pattambi', '53': 'Perinthalmanna', '54': 'Ponnani', '55': 'Tirur', '56': 'Koyilandi', '57': 'Koduvally', '58': 'Thalassery', '59': 'Thaliparamba', '60': 'Kanhangad', '61': 'Kunnathur', '62': 'Ranni', '63': 'Angamaly', '64': 'Chalakkudy', '65': 'Thirurangadi', '66': 'Kuttanadu', '67': 'Uzhavoor', '68': 'Devikulam', '69': 'Udumbanchola', '70': 'Chittur', '71': 'Nilambur', '72': 'Mananthavadi', '73': 'Sulthan Bathery' },
            'AP': { '01': 'Adilabad', '02': 'Anantapur', '03': 'Chittoor', '04': 'Kadapa', '05': 'Kakinada', '06': 'Kakinada', '07': 'Guntur', '08': 'Guntur', '09': 'Hyderabad Central', '10': 'Hyderabad North', '11': 'Hyderabad East', '12': 'Hyderabad South', '13': 'Hyderabad West', '14': 'Hyderabad', '15': 'Karimnagar', '16': 'Vijayawada', '17': 'Vijayawada', '18': 'Vijayawada', '19': 'Vijayawada', '20': 'Khammam', '21': 'Kurnool', '22': 'Mahbubnagar', '23': 'Medak', '24': 'Nalgonda', '25': 'Nizamabad', '26': 'Nellore', '27': 'Ongole', '28': 'Ranga Reddy', '29': 'Ranga Reddy', '30': 'Srikakulam', '31': 'Visakhapatnam', '32': 'Visakhapatnam', '33': 'Gajuwaka', '35': 'Vizianagaram', '36': 'Warangal', '37': 'Eluru' },
            'MH': { '01': 'Mumbai (South) - Tardeo', '02': 'Mumbai (West) - Andheri', '03': 'Mumbai (East) - Ghatkopar', '04': 'Thane', '05': 'Kalyan', '06': 'Raigad', '07': 'Sindhudurg Nagari', '08': 'Ratnagiri', '09': 'Kolhapur', '10': 'Sangli', '11': 'Satara', '12': 'Pune', '13': 'Solapur', '14': 'Pimpri Chinchwad', '16': 'Ahmednagar', '17': 'Shrirampur - Ahmednagar', '18': 'Dhule', '19': 'Jalgaon', '20': 'Aurangabad', '21': 'Jalna', '22': 'Parbhani', '23': 'Beed', '24': 'Latur', '25': 'Osmanabad', '26': 'Nanded', '27': 'Amravati', '28': 'Buldana', '29': 'Yavatmal', '30': 'Akola', '31': 'Nagpur', '33': 'Gadchiroli', '34': 'Chandrapur', '35': 'Gondia', '36': 'Bhandara', '37': 'Washim', '38': 'Hingoli', '39': 'Nandurbar', '40': 'Wadi Nagpur', '41': 'Malegaon - Nashik District', '42': 'Baramati - Pune', '43': 'Vashi (Sanpada)', '44': 'Ambejogai Beed', '45': 'Akluj - Solapur', '46': 'Panvel', '47': 'Borivali', '48': 'Vasai - Virar', '49': 'Nagpur (East) - Bhandara Road', '50': 'Karad', '51': 'Sangamner - Ahmednagar', '52': 'Parbhani (Rural)', '53': 'Pune South', '54': 'Pune North', '55': 'Mumbai Central', '56': 'Thane Rural' },
            'TS': { '01': 'Adilabad', '02': 'Karimnagar', '03': 'Warangal', '04': 'Khammam', '05': 'Nalgonda', '06': 'Mahbubnagar', '07': 'Ranga Reddy', '08': 'Ranga Reddy', '09': 'Hyderabad Central', '10': 'Hyderabad North', '11': 'Hyderabad East', '12': 'Hyderabad South', '13': 'Hyderabad West', '14': 'Hyderabad', '15': 'Medak', '16': 'Nizamabad' }
        };
        
        // Create separate RTO lists for state code variants
        // TN-CHN: Only Chennai RTOs (subset)
        rtoMasterData['TN-CHN'] = {
            '01': 'CHENNAI CENTRAL',
            '02': 'CHENNAI (NORTH WEST)',
            '03': 'CHENNAI (NORTH EAST)',
            '04': 'CHENNAI (EAST)',
            '05': 'CHENNAI (NORTH)',
            '06': 'CHENNAI (SOUTH-EAST)',
            '07': 'CHENNAI (SOUTH)',
            '09': 'CHENNAI WEST',
            '10': 'CHENNAI (SOUTH-WEST)',
            '11': 'TAMBARAM',
            '12': 'PARUTHIPATTU',
            '13': 'AMBATTUR',
            '14': 'SHOLINGANALLUR',
            '18': 'REDHILLS',
            '22': 'MEENAMBAKKAM',
            '85': 'KUNDRATHUR'
        };
        
        // TN_CHN: Alias using underscore
        rtoMasterData['TN_CHN'] = rtoMasterData['TN-CHN'];
        
        // TN-PY: Puducherry RTOs with PY- prefix (used with Tamil Nadu state)
        rtoMasterData['TN-PY'] = {
            'PY-01': 'Puducherry',
            'PY-02': 'Karaikal',
            'PY-03': 'Mahe',
            'PY-04': 'Yanam',
            'PY-05': 'Oulgaret'
        };
        
        // TN_PY: Alias using underscore
        rtoMasterData['TN_PY'] = rtoMasterData['TN-PY'];

        // Also allow selecting 'PY' (Puducherry) to show the same Puducherry RTOs
        rtoMasterData['PY'] = rtoMasterData['TN-PY'];

        // ==================== UTILITY FUNCTIONS ====================
        
        async function fetchAPI(url) {
            try {
                const response = await fetch(url);
                return await response.json();
            } catch (error) {
                console.error('API fetch error:', error);
                return null;
            }
        }

        function createOption(value, label) {
            const option = document.createElement('option');
            option.value = value;
            option.textContent = label;
            return option;
        }

        function clearSelect(select) {
            select.innerHTML = '';
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = '-- Choose --';
            select.appendChild(defaultOption);
        }

        // ==================== DATABASE DROPDOWN INITIALIZATION ====================
        
        let formElements = {};

        async function initializeDropdowns() {
            // Get all form elements
            formElements = {
                state: document.getElementById('state'),
                rtoNumber: document.getElementById('rto-number'),
                vehicleCategory: document.getElementById('vehicle-category'),
                vehicleType: document.getElementById('vehicle-type'),
                fuelType: document.getElementById('fuel-type'),
                policyType: document.getElementById('policy-type'),
                businessType: document.getElementById('business-type'),
                vehicleAge: document.getElementById('vehicle-age'),
                ccSlab: document.getElementById('cc-slab'),
                gvwValue: document.getElementById('gvw-value'),
                wattSlab: document.getElementById('watt-slab'),
                seatingCapacity: document.getElementById('seating-capacity'),
                ncbSlab: document.getElementById('ncb-slab'),
                cpaCover: document.getElementById('cpa-cover'),
                zeroDep: document.getElementById('zero-dep'),
                trailer: document.getElementById('trailer'),
                make: document.getElementById('make'),
                model: document.getElementById('model')
            };

            // Fetch and populate States
            const statesData = await fetchAPI('/api/states');
            if (statesData && statesData.states) {
                // Custom mapping for display names
                const stateDisplayMap = {
                    'TN': 'Tamil Nadu',
                    'PY': 'Puducherry',
                    'TN-CHN': 'Tamil Nadu - Chennai',
                    'TN-PY': 'Tamil Nadu - Pondicherry',
                    'TN_CHN': 'Tamil Nadu - Chennai',
                    'TN_PY': 'Tamil Nadu - Pondicherry'
                };
                statesData.states.forEach(state => {
                    // If state is a code, map to display name
                    const displayName = stateDisplayMap[state] || state;
                    formElements.state.appendChild(createOption(state, displayName));
                });
            }

            // Fetch and populate Policy Types
            const policyData = await fetchAPI('/api/policy-types');
            if (policyData && policyData.policies) {
                policyData.policies.forEach(policy => {
                    formElements.policyType.appendChild(createOption(policy, policy));
                });
            }

            // Fetch and populate Business Types (excluding 'All')
            // Clear existing options and add a specific placeholder
            formElements.businessType.innerHTML = '';
            const businessPlaceholder = document.createElement('option');
            businessPlaceholder.value = '';
            businessPlaceholder.textContent = '-- Choose Business Type --';
            formElements.businessType.appendChild(businessPlaceholder);

            const businessData = await fetchAPI('/api/business-types');
            if (businessData && businessData.business_types) {
                businessData.business_types.forEach(business => {
                    formElements.businessType.appendChild(createOption(business, business));
                });
            }

            // Populate Vehicle Ages as numeric choices 1..50 (use numeric filtering server-side)
            formElements.vehicleAge.innerHTML = '';
            const agePlaceholder = document.createElement('option');
            agePlaceholder.value = '';
            agePlaceholder.textContent = '-- Choose Vehicle Age --';
            formElements.vehicleAge.appendChild(agePlaceholder);
            for (let a = 1; a <= 50; a++) {
                formElements.vehicleAge.appendChild(createOption(String(a), String(a)));
            }

            // Fetch and populate Vehicle Categories
            const categoryData = await fetchAPI('/api/vehicle-categories');
            if (categoryData && categoryData.categories) {
                categoryData.categories.forEach(category => {
                    formElements.vehicleCategory.appendChild(createOption(category, category));
                });
            }

            // If category is Private-Car, hide the vehicle-type (sub-category) selector
            // and default it to 'Private Car' for user-friendliness
            function syncVehicleSubcategoryVisibility() {
                const cat = formElements.vehicleCategory.value;
                const vt = document.getElementById('vehicle-type');
                if (!vt) return;
                if (cat === 'Private-Car') {
                    // Ensure an option 'Private Car' exists and select it
                    let found = false;
                    for (let i = 0; i < vt.options.length; i++) {
                        if (vt.options[i].value === 'Private Car') { found = true; break; }
                    }
                    if (!found) {
                        vt.appendChild(createOption('Private Car', 'Private Car'));
                    }
                    vt.value = 'Private Car';
                    // Hide the whole control (assumes select is inside a .form-group)
                    if (vt.parentElement) vt.parentElement.style.display = 'none';
                } else {
                    // Show the sub-category when not Private-Car
                    if (vt.parentElement) vt.parentElement.style.display = 'block';
                }
            }
            formElements.vehicleCategory.addEventListener('change', () => {
                syncVehicleSubcategoryVisibility();
                // Also trigger vehicle type handler to refresh dependent fields
                if (typeof onVehicleTypeChange === 'function') onVehicleTypeChange();
            });
            // Run once to apply initial visibility
            syncVehicleSubcategoryVisibility();

            // Fetch and populate NCB Slabs
            const ncbData = await fetchAPI('/api/ncb-slabs');
            if (ncbData && ncbData.ncb_slabs) {
                ncbData.ncb_slabs.forEach(ncb => {
                    formElements.ncbSlab.appendChild(createOption(ncb, ncb));
                });
            }

            // Fetch and populate CPA Covers
            const cpaData = await fetchAPI('/api/cpa-covers');
            if (cpaData && cpaData.cpa_covers) {
                cpaData.cpa_covers.forEach(cpa => {
                    formElements.cpaCover.appendChild(createOption(cpa, cpa));
                });
            }

            // Fetch and populate Zero Depreciation
            const zeroDepData = await fetchAPI('/api/zero-depreciation');
            if (zeroDepData && zeroDepData.options) {
                zeroDepData.options.forEach(option => {
                    formElements.zeroDep.appendChild(createOption(option, option));
                });
            }

            // Add event listeners for dependent dropdowns
            formElements.state.addEventListener('change', onStateChange);
            formElements.vehicleCategory.addEventListener('change', onVehicleCategoryChange);
            formElements.vehicleType.addEventListener('change', onVehicleTypeChange);
            formElements.fuelType.addEventListener('change', onFuelTypeChange);
            formElements.make.addEventListener('change', onMakeChange);
        }

        // ==================== EVENT HANDLERS FOR DEPENDENT DROPDOWNS ====================
        
        async function onStateChange() {
            const stateDisplayName = formElements.state.value;
            
            if (!stateDisplayName) {
                clearSelect(formElements.rtoNumber);
                document.getElementById('rto-prefix').textContent = 'XX';
                return;
            }

            // Get state code from display name via API
            const stateCodeResponse = await fetchAPI(`/api/state-code/${encodeURIComponent(stateDisplayName)}`);
            const stateCode = stateCodeResponse?.code || stateDisplayName;
            
            // Update RTO prefix with state code
            document.getElementById('rto-prefix').textContent = stateCode;
            
            // Get RTO names from master data for this state
            const rtoNamesForState = rtoMasterData[stateCode] || {};
            
            // Populate RTO dropdown with codes and names from master data
            clearSelect(formElements.rtoNumber);
            
            // Sort RTO codes numerically
            const rtoCodesFromMaster = Object.keys(rtoNamesForState).sort((a, b) => {
                const numA = parseInt(a);
                const numB = parseInt(b);
                if (isNaN(numA) || isNaN(numB)) {
                    return a.localeCompare(b);
                }
                return numA - numB;
            });
            
            // Add options with code and name
            rtoCodesFromMaster.forEach(code => {
                const name = rtoNamesForState[code];
                formElements.rtoNumber.appendChild(createOption(code, `${code} - ${name}`));
            });
        }

        async function onVehicleCategoryChange() {
            const category = formElements.vehicleCategory.value;
            
            if (!category) {
                clearSelect(formElements.vehicleType);
                return;
            }

            // Fetch vehicle types for selected category
            const typeData = await fetchAPI(`/api/vehicle-types?category=${category}`);
            clearSelect(formElements.vehicleType);
            
            if (typeData && typeData.types) {
                typeData.types.forEach(type => {
                    formElements.vehicleType.appendChild(createOption(type, type));
                });
            }

            // Hide optional groups until vehicle type is selected
            document.getElementById('make-group').style.display = 'none';
            document.getElementById('model-group').style.display = 'none';
            document.getElementById('cc-group').style.display = 'none';
            document.getElementById('gvw-group').style.display = 'none';
            document.getElementById('watt-group').style.display = 'none';
            document.getElementById('seating-group').style.display = 'none';
            document.getElementById('trailer-group').style.display = 'none';
        }

        async function onVehicleTypeChange() {
            const vehicleType = formElements.vehicleType.value;
            const category = formElements.vehicleCategory.value;
            
            if (!vehicleType) {
                document.getElementById('make-group').style.display = 'none';
                document.getElementById('model-group').style.display = 'none';
                clearSelect(formElements.fuelType);
                clearSelect(formElements.make);
                return;
            }

            // Handle fuel selector for Flatbed: hide and do not fetch fuels
            if (vehicleType === 'Flatbed') {
                document.getElementById('fuel-group').style.display = 'none';
                clearSelect(formElements.fuelType);
                if (formElements.fuelType) formElements.fuelType.value = '';
            } else {
                // Fetch fuel types for selected vehicle type
                const fuelData = await fetchAPI(`/api/fuel-types?vehicle_type=${vehicleType}`);
                clearSelect(formElements.fuelType);
                if (fuelData && fuelData.fuels) {
                    fuelData.fuels.forEach(fuel => {
                        formElements.fuelType.appendChild(createOption(fuel, fuel));
                    });
                }
                // ensure fuel-group visible by default here; final visibility logic may override
                document.getElementById('fuel-group').style.display = 'block';
            }

            // Skip make/model fetching for Misc category (not needed)
            const catNorm = (c) => (c || '').toLowerCase().replace(/\s+/g, '-').replace(/-/g, '');
            const isMisc = (c) => catNorm(c).includes('misc');
            
            if (!isMisc(category)) {
                // Fetch makes for selected vehicle type
                const makeData = await fetchAPI(`/api/makes?vehicle_type=${vehicleType}`);
                clearSelect(formElements.make);
                
                if (makeData && makeData.makes && makeData.makes.length > 0) {
                    document.getElementById('make-group').style.display = 'block';
                    makeData.makes.forEach(make => {
                        formElements.make.appendChild(createOption(make, make));
                    });
                    // Add "Other" option for unspecified makes
                    formElements.make.appendChild(createOption('Other', 'Other'));
                } else {
                    // Always show Make selector even if DB has no makes for this vehicle type.
                    // Provide at least the 'Other' option so user can still enter a make.
                    document.getElementById('make-group').style.display = 'block';
                    formElements.make.appendChild(createOption('Other', 'Other'));

                    // Populate models directly based on vehicle_type so the UI still shows Model choices.
                    const vehicleTypeParamForModel = encodeURIComponent(vehicleType || '');
                    const modelDataFallback = await fetchAPI(`/api/models?vehicle_type=${vehicleTypeParamForModel}`);
                    clearSelect(formElements.model);
                    if (modelDataFallback && modelDataFallback.models && modelDataFallback.models.length > 0) {
                        document.getElementById('model-group').style.display = 'block';
                        modelDataFallback.models.forEach(m => {
                            formElements.model.appendChild(createOption(m, m));
                        });
                        formElements.model.appendChild(createOption('Other', 'Other'));
                    } else {
                        // Still show Model selector with only 'Other' so users can type/select a custom model
                        document.getElementById('model-group').style.display = 'block';
                        formElements.model.appendChild(createOption('Other', 'Other'));
                    }
                }
            }

            // Normalize category for visibility (API may return "Two-Wheeler", "GCV", "Goods Carrying Vehicle", etc.)
            const catNorm2 = (c) => (c || '').toLowerCase().replace(/\s+/g, '-').replace(/-/g, '');
            const isTwoWheeler = (c) => catNorm2(c).includes('wheeler') || catNorm2(c) === 'twowheeler';
            const isGcv = (c) => catNorm2(c).includes('gcv') || catNorm2(c).includes('goods');
            const isPcv = (c) => {
                const n = catNorm2(c);
                return (n.includes('pcv') || n.includes('passenger')) && !isTwoWheeler(c);
            };
            const isMisc2 = (c) => catNorm2(c).includes('misc');

            // For Misc category: hide make, model, and fuel (not needed for Misc vehicles)
            if (isMisc2(category)) {
                document.getElementById('make-group').style.display = 'none';
                document.getElementById('model-group').style.display = 'none';
                document.getElementById('fuel-group').style.display = 'none';
                clearSelect(formElements.make);
                clearSelect(formElements.model);
                clearSelect(formElements.fuelType);
                if (formElements.fuelType) formElements.fuelType.value = '';
            }

            // Handle CC and GVW based on category
            const catNorm3 = (c) => (c || '').toLowerCase().replace(/\s+/g, '-').replace(/-/g, '');
            if (isTwoWheeler(category)) {
                document.getElementById('cc-group').style.display = 'block';
                const vehicleTypeParam = encodeURIComponent(vehicleType || '');
                const fuelParam = encodeURIComponent(formElements.fuelType.value || '');
                const ccData = await fetchAPI(`/api/cc-slabs?vehicle_type=${vehicleTypeParam}&fuel_type=${fuelParam}`);
                clearSelect(formElements.ccSlab);
                if (ccData && ccData.cc_slabs) {
                    ccData.cc_slabs.forEach(cc => {
                        formElements.ccSlab.appendChild(createOption(cc, cc));
                    });
                }
            } else if (catNorm3(category).includes('privatecar') || catNorm3(category).includes('private')) {
                // Private Car: CC slab for Petrol/Diesel, Watt slab for EV
                const currentFuel = formElements.fuelType.value || '';
                const vehicleTypeParam = encodeURIComponent(vehicleType || '');
                const fuelParam = encodeURIComponent(currentFuel || '');
                
                if (currentFuel.toUpperCase() === 'EV') {
                    document.getElementById('watt-group').style.display = 'block';
                    document.getElementById('cc-group').style.display = 'none';
                    const wattData = await fetchAPI(`/api/watt-slabs?vehicle_type=${vehicleTypeParam}&fuel_type=${fuelParam}`);
                    clearSelect(formElements.wattSlab);
                    if (wattData && wattData.watt_slabs) {
                        wattData.watt_slabs.forEach(watt => {
                            formElements.wattSlab.appendChild(createOption(watt, watt));
                        });
                    }
                } else if (currentFuel) {
                    document.getElementById('cc-group').style.display = 'block';
                    document.getElementById('watt-group').style.display = 'none';
                    const ccData = await fetchAPI(`/api/cc-slabs?vehicle_type=${vehicleTypeParam}&fuel_type=${fuelParam}`);
                    clearSelect(formElements.ccSlab);
                    if (ccData && ccData.cc_slabs) {
                        ccData.cc_slabs.forEach(cc => {
                            formElements.ccSlab.appendChild(createOption(cc, cc));
                        });
                    }
                } else {
                    // No fuel selected yet, show CC group by default
                    document.getElementById('cc-group').style.display = 'block';
                    document.getElementById('watt-group').style.display = 'none';
                }
            } else {
                document.getElementById('cc-group').style.display = 'none';
                document.getElementById('watt-group').style.display = 'none';
                formElements.ccSlab.value = '';
            }
            if (isGcv(category)) {
                // GVW only for "4 Wheeler Goods" - MANDATORY for this vehicle type
                if (vehicleType === '4 Wheeler Goods') {
                    document.getElementById('gvw-group').style.display = 'block';
                    const vehicleTypeParam = encodeURIComponent(vehicleType || '');
                    const gvwData = await fetchAPI(`/api/gvw-slabs?vehicle_type=${vehicleTypeParam}`);
                    console.log('[DEBUG] GVW Enabled: GCV + 4 Wheeler Goods selected');
                } else {
                    document.getElementById('gvw-group').style.display = 'none';
                    if (formElements.gvwValue) formElements.gvwValue.value = '';
                    console.log('[DEBUG] GVW Hidden: ' + vehicleType + ' is not 4 Wheeler Goods');
                }
            } else {
                document.getElementById('gvw-group').style.display = 'none';
                if (formElements.gvwValue) formElements.gvwValue.value = '';
            }
            // Hide seating capacity for Auto (not applicable)
            if (isPcv(category) && vehicleType !== 'Auto') {
                document.getElementById('seating-group').style.display = 'block';
                const vehicleTypeParam = encodeURIComponent(vehicleType || '');
                const fuelParam = encodeURIComponent(formElements.fuelType.value || '');
                const seatingData = await fetchAPI(`/api/seating-capacities?vehicle_type=${vehicleTypeParam}&fuel_type=${fuelParam}`);
                clearSelect(formElements.seatingCapacity);
                if (seatingData && seatingData.capacities) {
                    // Filter out 'N/A' values (they are represented by 'Other' option below)
                    const filteredSeats = seatingData.capacities.filter(seat => seat.toUpperCase() !== 'N/A');
                    filteredSeats.forEach(seat => {
                        formElements.seatingCapacity.appendChild(createOption(seat, seat));
                    });
                    // Always add 'Other' option (represents N/A = all seats applicable)
                    formElements.seatingCapacity.appendChild(createOption('Other', 'Other'));
                }
            } else {
                document.getElementById('seating-group').style.display = 'none';
                if (formElements.seatingCapacity) formElements.seatingCapacity.value = '';
            }

            // Show trailer only for Misc (Tractor)
            if (isMisc2(category)) {
                // Trailer only for "Tractor"
                if (vehicleType === 'Tractor') {
                    document.getElementById('trailer-group').style.display = 'block';
                    const vehicleTypeParam = encodeURIComponent(vehicleType || '');
                    const trailerData = await fetchAPI(`/api/trailers?vehicle_type=${vehicleTypeParam}`);
                    clearSelect(formElements.trailer);
                    if (trailerData && trailerData.trailers) {
                        trailerData.trailers.forEach(trailer => {
                            formElements.trailer.appendChild(createOption(trailer, trailer));
                        });
                    }
                } else {
                    document.getElementById('trailer-group').style.display = 'none';
                    if (formElements.trailer) formElements.trailer.value = '';
                }
            } else {
                document.getElementById('trailer-group').style.display = 'none';
                if (formElements.trailer) formElements.trailer.value = '';
            }

            // For PCV: hide fuel type for bus categories (buses only depend on seating)
            // For Misc: hide fuel (not needed for Misc vehicles)
            const bus_types = ['Educational Bus', 'Educational Bus under school name', 'Staff Bus'];
            if (vehicleType === 'Flatbed' || isMisc2(category) || (isPcv(category) && bus_types.includes(vehicleType))) {
                document.getElementById('fuel-group').style.display = 'none';
                if (formElements.fuelType) formElements.fuelType.value = '';
            } else {
                document.getElementById('fuel-group').style.display = 'block';
            }
            
            // Reload optional fields that depend on vehicle type and fuel type
            await reloadOptionalFields();
        }

        async function onFuelTypeChange() {
            const fuel = formElements.fuelType.value;
            const category = formElements.vehicleCategory.value;
            const catNorm = (c) => (c || '').toLowerCase().replace(/\s+/g, '-').replace(/-/g, '');
            const catNorm2 = (c) => (c || '').toLowerCase().replace(/\s+/g, '-').replace(/-/g, '');
            const isTwoWheeler = (c) => catNorm(c).includes('wheeler') || catNorm(c) === 'twowheeler';

            const vehicleTypeParam = encodeURIComponent(formElements.vehicleType.value || '');
            const fuelParam = encodeURIComponent(fuel || '');

            // Show Watt ONLY for electric two-wheelers (EV); CC for non-electric two-wheelers
            if (isTwoWheeler(category) && (fuel || '').toUpperCase() === 'EV') {
                document.getElementById('watt-group').style.display = 'block';
                document.getElementById('cc-group').style.display = 'none';
                const wattData = await fetchAPI(`/api/watt-slabs?vehicle_type=${vehicleTypeParam}&fuel_type=${fuelParam}`);
                clearSelect(formElements.wattSlab);
                if (wattData && wattData.watt_slabs) {
                    wattData.watt_slabs.forEach(watt => {
                        formElements.wattSlab.appendChild(createOption(watt, watt));
                    });
                }
            } else if (isTwoWheeler(category)) {
                document.getElementById('cc-group').style.display = 'block';
                document.getElementById('watt-group').style.display = 'none';
                const ccData = await fetchAPI(`/api/cc-slabs?vehicle_type=${vehicleTypeParam}&fuel_type=${fuelParam}`);
                clearSelect(formElements.ccSlab);
                if (ccData && ccData.cc_slabs) {
                    ccData.cc_slabs.forEach(cc => {
                        formElements.ccSlab.appendChild(createOption(cc, cc));
                    });
                }
            } else if (catNorm2(category).includes('privatecar') || catNorm2(category).includes('private')) {
                // Private Car: Show Watt ONLY for EV, CC for Petrol/Diesel
                if ((fuel || '').toUpperCase() === 'EV') {
                    document.getElementById('watt-group').style.display = 'block';
                    document.getElementById('cc-group').style.display = 'none';
                    const wattData = await fetchAPI(`/api/watt-slabs?vehicle_type=${vehicleTypeParam}&fuel_type=${fuelParam}`);
                    clearSelect(formElements.wattSlab);
                    if (wattData && wattData.watt_slabs) {
                        wattData.watt_slabs.forEach(watt => {
                            formElements.wattSlab.appendChild(createOption(watt, watt));
                        });
                    }
                } else if (fuel) {
                    document.getElementById('cc-group').style.display = 'block';
                    document.getElementById('watt-group').style.display = 'none';
                    const ccData = await fetchAPI(`/api/cc-slabs?vehicle_type=${vehicleTypeParam}&fuel_type=${fuelParam}`);
                    clearSelect(formElements.ccSlab);
                    if (ccData && ccData.cc_slabs) {
                        ccData.cc_slabs.forEach(cc => {
                            formElements.ccSlab.appendChild(createOption(cc, cc));
                        });
                    }
                }
            }
            
            // Reload optional fields that depend on vehicle type and fuel type
            await reloadOptionalFields();
        }

        async function onMakeChange() {
            const make = formElements.make.value;
            
            if (!make || make === 'Other') {
                // Show model selector and provide 'Other' as a choice when Make is 'Other' or empty
                clearSelect(formElements.model);
                document.getElementById('model-group').style.display = 'block';
                formElements.model.appendChild(createOption('Other', 'Other'));
                return;
            }

            // Fetch models for selected make
            const vehicleTypeParam = encodeURIComponent(formElements.vehicleType.value || '');
            const modelData = await fetchAPI(`/api/models?make=${encodeURIComponent(make)}&vehicle_type=${vehicleTypeParam}`);
            clearSelect(formElements.model);
            
            if (modelData && modelData.models && modelData.models.length > 0) {
                document.getElementById('model-group').style.display = 'block';
                modelData.models.forEach(model => {
                    formElements.model.appendChild(createOption(model, model));
                });
                // Add "Other" option for unspecified models
                formElements.model.appendChild(createOption('Other', 'Other'));
            } else {
                // Still show model group but with only "Other" option
                document.getElementById('model-group').style.display = 'block';
                formElements.model.appendChild(createOption('Other', 'Other'));
            }
        }

        async function reloadOptionalFields() {
            // Reload optional fields based on current vehicle_type and fuel_type
            const vehicleTypeParam = encodeURIComponent(formElements.vehicleType.value || '');
            const fuelParam = encodeURIComponent(formElements.fuelType.value || '');
            
            // Reload Policy Types (filtered by vehicle_type and fuel_type)
            const policyUrl = `/api/policy-types?vehicle_type=${vehicleTypeParam}&fuel_type=${fuelParam}`;
            console.log('[RELOAD] Fetching policies from:', policyUrl);
            const policyData = await fetchAPI(policyUrl);
            console.log('[RELOAD] Policy data received:', policyData);
            clearSelect(formElements.policyType);
            if (policyData && Array.isArray(policyData.policies) && policyData.policies.length > 0) {
                console.log('[RELOAD] Populating', policyData.policies.length, 'policies');
                policyData.policies.forEach(policy => {
                    formElements.policyType.appendChild(createOption(policy, policy));
                });
            } else {
                console.warn('[RELOAD] No policies received or invalid format');
            }
            
            // Reload Business Types (filtered by vehicle_type and fuel_type)
            const businessUrl = `/api/business-types?vehicle_type=${vehicleTypeParam}&fuel_type=${fuelParam}`;
            console.log('[RELOAD] Fetching business types from:', businessUrl);
            const businessData = await fetchAPI(businessUrl);
            console.log('[RELOAD] Business type data received:', businessData);
            clearSelect(formElements.businessType);
            if (businessData && Array.isArray(businessData.business_types) && businessData.business_types.length > 0) {
                console.log('[RELOAD] Populating', businessData.business_types.length, 'business types');
                businessData.business_types.forEach(business => {
                    formElements.businessType.appendChild(createOption(business, business));
                });
            } else {
                console.warn('[RELOAD] No business types received or invalid format');
            }
            
            // Reload NCB Slabs
            const ncbData = await fetchAPI(`/api/ncb-slabs?vehicle_type=${vehicleTypeParam}&fuel_type=${fuelParam}`);
            clearSelect(formElements.ncbSlab);
            if (ncbData && ncbData.ncb_slabs) {
                ncbData.ncb_slabs.forEach(ncb => {
                    formElements.ncbSlab.appendChild(createOption(ncb, ncb));
                });
            }
            
            // Reload CPA Covers
            const cpaData = await fetchAPI(`/api/cpa-covers?vehicle_type=${vehicleTypeParam}&fuel_type=${fuelParam}`);
            clearSelect(formElements.cpaCover);
            if (cpaData && cpaData.cpa_covers) {
                cpaData.cpa_covers.forEach(cpa => {
                    formElements.cpaCover.appendChild(createOption(cpa, cpa));
                });
            }
            
            // Reload Zero Depreciation
            const zeroDepData = await fetchAPI(`/api/zero-depreciation?vehicle_type=${vehicleTypeParam}&fuel_type=${fuelParam}`);
            clearSelect(formElements.zeroDep);
            if (zeroDepData && zeroDepData.options) {
                zeroDepData.options.forEach(option => {
                    formElements.zeroDep.appendChild(createOption(option, option));
                });
            }
        }

        // ==================== FORM SUBMISSION ====================
        
        const form = document.querySelector('form');
        const submitButton = form.querySelector('button[type="submit"]');
        const resultsSection = document.getElementById('results-section');
        const resultsMessage = document.getElementById('results-message');
        const resultsTable = document.getElementById('results-table');
        const resultsBody = document.getElementById('results-body');

        function getSelectedLabel(selectEl) {
            if (!selectEl) return '';
            const idx = selectEl.selectedIndex;
            if (idx < 0) return '';
            return selectEl.options[idx]?.textContent?.trim() || '';
        }

        function buildCriteriaSummary() {
            const criteriaSummary = document.getElementById('criteria-summary');
            if (!criteriaSummary) return;

            const rtoCode = `${rtoPrefix?.textContent || ''}${formElements.rtoNumber?.value || ''}`.trim();

            const criteria = {
                'State': getSelectedLabel(formElements.state) || formElements.state?.value,
                'RTO Code': rtoCode || getSelectedLabel(formElements.rtoNumber) || formElements.rtoNumber?.value,
                'Vehicle Category': getSelectedLabel(formElements.vehicleCategory) || formElements.vehicleCategory?.value,
                'Vehicle Type': getSelectedLabel(formElements.vehicleType) || formElements.vehicleType?.value,
                'Fuel Type': getSelectedLabel(formElements.fuelType) || formElements.fuelType?.value,
                'Vehicle Age': getSelectedLabel(formElements.vehicleAge) || formElements.vehicleAge?.value,
                'Policy Type': getSelectedLabel(formElements.policyType) || formElements.policyType?.value,
                'Business Type': getSelectedLabel(formElements.businessType) || formElements.businessType?.value,
                'NCB': getSelectedLabel(formElements.ncbSlab) || formElements.ncbSlab?.value,
                'CPA Cover': getSelectedLabel(formElements.cpaCover) || formElements.cpaCover?.value,
                'Zero Depreciation': getSelectedLabel(formElements.zeroDep) || formElements.zeroDep?.value,
                'Seating Capacity': getSelectedLabel(formElements.seatingCapacity) || formElements.seatingCapacity?.value,
                'CC Slab': getSelectedLabel(formElements.ccSlab) || formElements.ccSlab?.value,
                'GVW (kg)': formElements.gvwValue?.value || '',
                'Watt Slab': getSelectedLabel(formElements.wattSlab) || formElements.wattSlab?.value,
                'Trailer': getSelectedLabel(formElements.trailer) || formElements.trailer?.value,
                'Make': getSelectedLabel(formElements.make) || formElements.make?.value,
                'Model': getSelectedLabel(formElements.model) || formElements.model?.value
            };

            let criteriaHTML = '<div class="results-subtitle">Query submitted with</div><div class="criteria-grid">';
            for (const [key, value] of Object.entries(criteria)) {
                if (value && String(value).trim() !== '' && String(value).trim() !== '-- Choose --') {
                    criteriaHTML += `<div class="criteria-item"><span class="criteria-key">${key}</span><span class="criteria-value">${value}</span></div>`;
                }
            }
            criteriaSummary.innerHTML = criteriaHTML + '</div>';
        }

        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            console.log('[FORM] Form submit event triggered');
            console.log('[FORM] vehicleCategory:', formElements.vehicleCategory?.value);
            console.log('[FORM] vehicleType:', formElements.vehicleType?.value);

            // Validate: all visible required fields must be filled
            const missing = [];
            if (!formElements.state?.value) missing.push('State');
            if (!formElements.rtoNumber?.value) missing.push('RTO Code');
            if (!formElements.vehicleCategory?.value) missing.push('Vehicle Category');
            // Vehicle Type is not required when Vehicle Category is 'Private-Car' (sub-category hidden)
            if (!(formElements.vehicleCategory?.value === 'Private-Car') && !formElements.vehicleType?.value) missing.push('Vehicle Type');
            // Only require fuel type if fuel-group is visible (e.g., not hidden for buses in PCV)
            if (document.getElementById('fuel-group').style.display !== 'none' && !formElements.fuelType?.value) missing.push('Fuel Type');
            if (!formElements.vehicleAge?.value) missing.push('Vehicle Age');
            if (!formElements.policyType?.value) missing.push('Policy Type');
            if (!formElements.businessType?.value) missing.push('Business Type');
            if (!formElements.ncbSlab?.value) missing.push('NCB Slab');
            if (!formElements.cpaCover?.value) missing.push('CPA Cover');
            if (!formElements.zeroDep?.value) missing.push('Zero Depreciation');
            if (document.getElementById('gvw-group').style.display !== 'none' && !formElements.gvwValue?.value) missing.push('GVW (kg)');
            
            // CC Slab: OPTIONAL for Two-Wheeler (matched against 'All' records when not selected)
            // Do NOT require CC slab selection to avoid user confusion
            // Empty CC slab value means "match any CC slab" (rows with null/All/No will still match)
            
            // Watt Slab: OPTIONAL for EV Two-Wheeler
            // Empty value means "match any watt slab" (rows with null/All/No will still match)
            if (document.getElementById('seating-group').style.display !== 'none' && !formElements.seatingCapacity?.value) missing.push('Seating Capacity');
            if (document.getElementById('trailer-group').style.display !== 'none' && !formElements.trailer?.value) missing.push('Trailer');

            if (missing.length > 0) {
                console.log('[FORM] Validation failed - missing fields:', missing);
                alert('Please fill all required fields:\n\n- ' + missing.join('\n- '));
                return;
            }
            
            console.log('[FORM] Validation passed - all required fields filled');

            buildCriteriaSummary();

            // Show loading state
            submitButton.disabled = true;
            submitButton.textContent = 'Calculating...';
            console.log('[FORM] Submitting form...');

            // Get form data (optional fields when hidden can be empty)
            const formData = new FormData(this);
            
            // DEBUG: Log all form parameters
            console.log('[FORM] Form data being submitted:');
            for (const [key, value] of formData.entries()) {
                console.log(`  ${key}: ${value}`);
            }
            
            try {
                // Make API call
                console.log('[FORM] Calling /check-payout endpoint...');
                const response = await fetch('/check-payout', {
                    method: 'POST',
                    body: formData
                });

                console.log('[FORM] Response status:', response.status, response.statusText);
                
                if (!response.ok) {
                    console.error('[FORM] HTTP error:', response.status);
                    const errorText = await response.text();
                    console.error('[FORM] Response body:', errorText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('[FORM] Response received:', data.status);
                console.log('[FORM] Full response:', JSON.stringify(data, null, 2));

                // Display results
                if (data.status === 'success' && data.top_3_payouts && data.top_3_payouts.length > 0) {
                    console.log(`[FORM] Found ${data.top_3_payouts.length} payouts`);
                    resultsMessage.textContent = data.message;
                    resultsTable.style.display = 'block';
                    resultsBody.innerHTML = '';
                    
                    data.top_3_payouts.forEach(payout => {
                        const row = document.createElement('tr');

                        // Format company name with conditions if present
                        const companyDisplay = payout.conditions 
                            ? `<strong>${payout.company_name}</strong><br/><span class="company-note">Note: ${payout.conditions}</span>`
                            : `<strong>${payout.company_name}</strong>`;

                        row.innerHTML = `
                            <td class="table-rank">${payout.rank}</td>
                            <td class="table-company">${companyDisplay}</td>
                            <td class="table-payout">${payout.payout_percentage.toFixed(2)}<span class="payout-unit">rp</span></td>
                        `;
                        resultsBody.appendChild(row);
                    });

                    resultsSection.style.display = 'block';
                    resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    console.log('[FORM] Results displayed successfully');
                } else if (data.status === 'success' && (!data.top_3_payouts || data.top_3_payouts.length === 0)) {
                    console.log('[FORM] Success but empty payouts array');
                    console.log('[FORM] data.status:', data.status);
                    console.log('[FORM] data.top_3_payouts:', data.top_3_payouts);
                    resultsMessage.textContent = data.message || 'No payout data found for this combination.';
                    resultsMessage.style.backgroundColor = '#fff3cd';
                    resultsMessage.style.borderLeftColor = '#ffc107';
                    resultsMessage.style.color = '#856404';
                    resultsBody.innerHTML = '';
                    resultsTable.style.display = 'none';
                    resultsSection.style.display = 'block';
                    resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                } else if (data.status === 'no_data') {
                    console.log('[FORM] No data status received');
                    resultsMessage.textContent = data.message || 'No payout data found for this combination. Database may be empty.';
                    resultsMessage.style.backgroundColor = '#fff3cd';
                    resultsMessage.style.borderLeftColor = '#ffc107';
                    resultsMessage.style.color = '#856404';
                    resultsBody.innerHTML = '';
                    resultsTable.style.display = 'none';
                    resultsSection.style.display = 'block';
                    resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                } else if (data.status === 'error' || data.status === 'ui_only') {
                    console.error('[FORM] Error or UI-only status:', data.status);
                    resultsMessage.textContent = data.message || 'Error processing request.';
                    resultsMessage.style.backgroundColor = '#ffebee';
                    resultsMessage.style.borderLeftColor = '#f44336';
                    resultsMessage.style.color = '#c62828';
                    resultsBody.innerHTML = '';
                    resultsTable.style.display = 'none';
                    resultsSection.style.display = 'block';
                    resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                } else {
                    console.warn('[FORM] Unexpected response status:', data.status);
                    console.warn('[FORM] Full response:', data);
                    resultsMessage.textContent = 'Unexpected response format. Please check browser console.';
                    resultsMessage.style.backgroundColor = '#fff3cd';
                    resultsMessage.style.borderLeftColor = '#ffc107';
                    resultsMessage.style.color = '#856404';
                    resultsBody.innerHTML = '';
                    resultsTable.style.display = 'none';
                    resultsSection.style.display = 'block';
                    resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            } catch (error) {
                console.error('[FORM] Exception caught:', error);
                console.error('[FORM] Stack trace:', error.stack);
                resultsMessage.textContent = 'Error: ' + error.message;
                resultsMessage.style.backgroundColor = '#ffebee';
                resultsMessage.style.borderLeftColor = '#f44336';
                resultsMessage.style.color = '#c62828';
                resultsBody.innerHTML = '';
                resultsTable.style.display = 'none';
                resultsSection.style.display = 'block';
                resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } finally {
                // Reset button state
                submitButton.disabled = false;
                submitButton.textContent = 'Calculate Payout';
                console.log('[FORM] Form submission complete');
            }
        });

        // Initialize dropdowns on page load
        document.addEventListener('DOMContentLoaded', initializeDropdowns);
    </script>
        <!-- Removed: Static rtoData structure - now fetched from API -->

        <script>
        // Old static RTO data has been removed - data is now fetched from database API

        // Age Slabs based on Vehicle Category and Sub-Category (from reference data)
        // NOTE: Age is now a numeric input (1-50), ranges will be matched on backend
        const ageSlabs = {
            'bike': [],
            'scooter': [],
            'private-car': [],
            'auto': [],
            'taxi': [],
            'educational-bus': [],
            'staff-bus': [],
            '3-wheeler-goods': [],
            '4-wheeler-goods': [],
            'flatbed': [],
            'tractor': [],
            'other-misc-vehicles': []
        };

        const stateSelect = document.getElementById('state');
        const rtoPrefix = document.getElementById('rto-prefix');
        const rtoNumberSelect = document.getElementById('rto-number');
        const vehicleCategorySelect = document.getElementById('vehicle-category');
        const vehicleTypeSelect = document.getElementById('vehicle-type');
        const vehicleAgeSelect = document.getElementById('vehicle-age');
        const fuelTypeSelect = document.getElementById('fuel-type');
        const ccGroup = document.getElementById('cc-group');
        const gvwGroup = document.getElementById('gvw-group');
        const wattGroup = document.getElementById('watt-group');
        const seatingGroup = document.getElementById('seating-group');
        const trailerGroup = document.getElementById('trailer-group');
        const makeGroup = document.getElementById('make-group');
        const modelGroup = document.getElementById('model-group');
        const makeSelect = document.getElementById('make');
        const modelSelect = document.getElementById('model');
        const policyTypeSelect = document.getElementById('policy-type');
        const ncbSlabSelect = document.getElementById('ncb-slab');
        const ccSlabSelect = document.getElementById('cc-slab');
        const seatingCapacitySelect = document.getElementById('seating-capacity');

        // Make/Model data by vehicle type
        // All dropdown data is fetched from database API
        // No hardcoded values

        // All data is now fetched from the database API - no hardcoded values

        // RTO prefix update and populate RTO names
        // NOTE: State change is now handled by onStateChange() function above via API
        // This old static listener is no longer used since we fetch RTOs from database
        /*
        stateSelect.addEventListener('change', function() {
            const selectedState = this.value;
            if (selectedState) {
                rtoPrefix.textContent = selectedState;
                
                // Populate RTO numbers with names - sorted in ascending order
                rtoNumberSelect.innerHTML = '';
                const placeholder = document.createElement('option');
                placeholder.value = '';
                placeholder.textContent = '-- Choose RTO Code --';
                placeholder.selected = true;
                rtoNumberSelect.appendChild(placeholder);
                
                const rtos = rtoData[selectedState];
                
                if (rtos) {
                    // Sort RTO codes in ascending order (numeric sorting with special handling)
                    const sortedCodes = Object.keys(rtos).sort((a, b) => {
                        const numA = parseInt(a);
                        const numB = parseInt(b);
                        if (numA !== numB) {
                            return numA - numB;  // Sort by numeric value
                        }
                        // If numeric parts are equal, sort alphabetically (e.g., '15' before '15M')
                        return a.localeCompare(b);
                    });
                    
                    for (const code of sortedCodes) {
                        const name = rtos[code];
                        const option = document.createElement('option');
                        option.value = code;
                        option.textContent = `${code} - ${name}`;
                        rtoNumberSelect.appendChild(option);
                    }
                }
                rtoNumberSelect.selectedIndex = 0;
                rtoNumberSelect.value = '';
                rtoNumberSelect.options[0].selected = true;
            } else {
                rtoPrefix.textContent = 'XX';
                rtoNumberSelect.innerHTML = '';
                const placeholder = document.createElement('option');
                placeholder.value = '';
                placeholder.textContent = '-- Choose RTO Code --';
                rtoNumberSelect.appendChild(placeholder);
            }
        });
        */

        // Legacy static handlers removed -- UI now uses API-driven handlers defined above

        // NCB is now directly selected by user (Yes/No only)
        // No need for derivation based on age or claim status
    </script>
        </div>
    </div>
</body>
</html>
